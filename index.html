<!DOCTYPE html>
<html lang="en">
  <head>
    <title>NEL-VCS-v1.0</title>
    <style>
      body {
        margin: 0;
        background-color: #000;
        color: #fff;
        font-family: Helvetica, Arial, sans-serif;
        overflow: hidden; /* disable scrolling / rubberband effect on mobile */
        height: 100vh;
      }

      .console {
        position: fixed;
        font-weight: lighter;
        opacity: 1;
        transition: opacity 0.5s ease-in-out;
      }

      canvas {
        display: block;
        position: absolute;
        outline: 0;
      }

      * {
        /* disable on touch highlights of html elements, especially on mobile! */
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
    </style>

    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1"
    />
    <meta itemprop="name" content="NEL-VCS-v1.0" />
    <meta itemprop="description" content="made with cables" />
    <meta itemprop="image" content="screenshot.png" />
    <meta name="description" content="made with cables" />
  </head>
  <body>
    <canvas id="glcanvas" width="100vw" height="100vh" tabindex="1"></canvas>

    <script
      type="text/javascript"
      src="./nel-vcs-24/js/patch.js"
      async
    ></script>

    <script type="text/javascript">
      let currentID = 0;
      let currentTimer;
      const getLogoDiv = () =>
        document.getElementsByClassName("cablesEle logo")[0];

      function showError(errId, errMsg) {
        // handle critical errors here if needed
        console.error("CRITICAL ERROR thrown from UI");
      }

      // Cables patch initialized, set up interop bindings
      // prepare for connecting patch vars to Elementary native

      function patchInitialized(patch) {
        console.log("patch initialized", CABLES);

        // strip styles from the logo that might be set by Cables
        getLogoDiv().removeAttribute("style");
        getLogoDiv().style =
          "position: fixed; visibility: visible; top: 0; left: 0";

        // get  all the variables from the Cables patch
        const cablesVariables = patch.getVars();
        console.log("cablesVariables", cablesVariables);
        // select only the variables with keys that start with the prefix "ui_"
        const uiVariables = Object.keys(cablesVariables).filter((key) =>
          key.startsWith("ui_")
        );

        // iterate over all the variables and set up generic event listeners
        // that will send the variable value to native plugin through
        // the requestParamValueUpdate function
        for (const key of uiVariables) {
          const value = cablesVariables[key];
          const paramId = key.replace("ui_", "");
          if (
            paramId !== "pickedID" &&
            paramId !== "readout" &&
            paramId !== "interpolatingPreset" &&
            paramId !== "paramsAverage"
          ) {
            value.on("change", function (newValue) {
              requestParamValueUpdate(paramId, newValue);
            });
          }
        }

        // special cases of variables that need to be handled differently
        const paramsAverage = patch.getVar("ui_paramsAverage");
        const pickedID = patch.getVar("pickedID");
        const readout = patch.getVar("readout");
        const interpolatingPreset = patch.getVar("ui_interpolatingPreset");

        // inerpolatingPreset is an array of all preset parameters
        // and is interpolated on the Cables side

        // extract the preset parameters from the array
        // and send them to native plugin
        // use the average as a change trigger

        if (paramsAverage) {
          paramsAverage.on("change", function (val) {
            const values = interpolatingPreset.getValue();
            if (values && values.length >= 4) {
              const params = ["decay", "mix", "mod", "size"];
              for (let i = 0; i < 4; i++) {
                if (values[i] !== undefined && params[i] !== undefined) {
                  requestParamValueUpdate(params[i], values[i]);
                }
              }
            }
          });
        }

        // pickedID is the index of the preset that is currently being picked under the mouse
        // it needs to be divided by 2 because the preset index is 2->72
        // but actually there are only 36 presets
        if (pickedID) {
          pickedID.on("change", function (id) {
            const element = getConsoleDiv();
            clearInterval(currentTimer);
            element.style.opacity = 1;
            currentTimer = setInterval(() => {
              element.style.opacity = 0;
            }, 3000);
            // store it in a global variable
            currentID = id / 2;

            // log to the console inside the patch
            const stem = "‣ ";
            patch.setVariable("topLeftText", stem + "Node » " + currentID);
          });
        }

        // readout is the value generated by dragging the mouse over the circle
        // requestParamValueUpdate is called here with the circleID and the readout value
        if (readout) {
          readout.on("change", function (newValue) {
            const element = getConsoleDiv();
            element.classList.add("fadeIn");
            requestParamValueUpdate("circleID", currentID / 36);
            requestParamValueUpdate("nodeValue", newValue);
          });
        }
      }

      function patchFinishedLoading(patch) {
        // The patch is ready now, all assets have been loaded
        // not used so far
      }

      document.addEventListener("CABLES.jsLoaded", function (event) {
        CABLES.patch = new CABLES.Patch({
          patch: CABLES.exportedPatch,
          prefixAssetPath: "",
          assetPath: "assets/",
          jsPath: "",
          glCanvasId: "glcanvas",
          glCanvasResizeToWindow: true,
          onError: showError,
          onPatchLoaded: patchInitialized,
          onFinishedLoading: patchFinishedLoading,
          canvas: { alpha: true, premultipliedAlpha: true }, // make canvas transparent
        });
      });

      // Interop bindings
      function requestParamValueUpdate(paramId, value) {
        if (typeof globalThis.__postNativeMessage__ === "function") {
          globalThis.__postNativeMessage__("setParameterValue", {
            paramId,
            value,
          });
        }
      }
    </script>
  </body>
</html>
